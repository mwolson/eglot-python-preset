# Plan: PEP-723 Support for Eglot

## Overview

PEP-723 defines a standard for embedding metadata directly within single-file
Python scripts using a special comment block format:

```python
# /// script
# requires-python = ">=3.11"
# dependencies = [
#   "requests",
#   "rich",
# ]
# ///
```

This allows tools like `uv` to:

1. Detect dependencies from inline metadata
2. Create/manage an isolated virtual environment for the script
3. Run the script with all dependencies available

## Goal

Create an Emacs library `eglot-python-preset.el` that:

1. Detects PEP-723 metadata in Python files
2. Sets the project root to the script's directory (so relative imports work)
3. Configures the LSP (ty or basedpyright) to use the correct Python interpreter
   from `uv python find --script`
4. Warns the user if the environment doesn't exist yet (without auto-installing)

## Architecture

### Project Detection

Each PEP-723 script is treated as its own project using `python-script` project
type (vs `python-project` for regular Python projects). This ensures each script
gets its own eglot server instance with the correct pythonPath.

- `eglot-python-preset--project-find` - Added to `project-find-functions`
- Returns `(python-script . SCRIPT-PATH)` for PEP-723 scripts
- Returns `(python-project . ROOT)` for regular Python projects

### Workspace Configuration (basedpyright)

Uses `defadvice :around` on `eglot--workspace-configuration-plist` to inject
`:python :pythonPath` for PEP-723 scripts. This approach:

- Doesn't replace `eglot-workspace-configuration` globally
- Merges with user's existing configuration
- Works with basedpyright's `workspace/configuration` requests

Key function: `eglot-python-preset--workspace-configuration-plist-a`

### Workspace Configuration (ty)

Uses `initializationOptions` passed via the server contact spec, since ty reads
environment configuration at startup.

Key function: `eglot-python-preset--init-options`

### Warning Deduplication

Uses `eglot-python-preset--warned-scripts` hash table to track scripts we've
already warned about unsynced environments. Cleared when user runs
`eglot-python-preset-sync-environment`.

## Key `uv` Commands

- **`uv python find --script <file>`** - Returns the Python interpreter path for
  the script
  - Returns system Python if environment not synced
  - Returns path in `~/.cache/uv/environments-v2/` if synced
- **`uv sync --script <file>`** - Creates/updates the script's virtual
  environment
- **`uv run <file>`** - Runs the script with dependencies

## LSP Configuration

### ty

Uses `initializationOptions` with:

```elisp
(:configuration
 (:environment
  (:python "/path/to/env"
   :root ["/path/to/script/dir"])))
```

### basedpyright

Uses workspace configuration (via advice) with:

```elisp
(:python (:pythonPath "/path/to/python"))
```

Merged with any user-provided `eglot-workspace-configuration`.

---

## Public API

| Function                                 | Description                               |
| ---------------------------------------- | ----------------------------------------- |
| `eglot-python-preset-has-metadata-p`     | Check if buffer has PEP-723 metadata      |
| `eglot-python-preset-get-python-path`    | Get Python path for script via uv         |
| `eglot-python-preset-sync-environment`   | Sync environment and restart eglot        |
| `eglot-python-preset-run-script`         | Run script with `uv run`                  |
| `eglot-python-preset-remove-environment` | Remove cached uv environment              |
| `eglot-python-preset-setup`              | Set up hooks, advice, and server programs |

## Internal Functions

| Function                                               | Description                                |
| ------------------------------------------------------ | ------------------------------------------ |
| `eglot-python-preset--uv-env-dir`                      | Get uv environments directory              |
| `eglot-python-preset--python-env-dir`                  | Extract env dir from python path           |
| `eglot-python-preset--merge-plists`                    | Recursively merge plists                   |
| `eglot-python-preset--workspace-configuration-plist-a` | Advice for workspace config (basedpyright) |
| `eglot-python-preset--init-options`                    | Return initializationOptions (ty)          |
| `eglot-python-preset--server-contact`                  | Return server contact spec                 |
| `eglot-python-preset--python-project-root-p`           | Check for Python project markers           |
| `eglot-python-preset--project-find`                    | Project detection for Python files         |

## Internal Variables

| Variable                              | Description                             |
| ------------------------------------- | --------------------------------------- |
| `eglot-python-preset--warned-scripts` | Hash table of scripts warned about sync |

---

## Dev Loop Commands

### Run tests

```bash
bun run test
# or
emacs -Q --batch -l eglot-python-preset.el -l test/pep-723/test.el
```

### Check parentheses in library

```bash
emacs -Q --batch --eval '(progn (with-temp-buffer (insert-file-contents "eglot-python-preset.el") (check-parens)))'
```

### Interactive testing

1. Open `test/pep-723/example-1.py` or `example-2.py` in Emacs
2. Check if warning appears (environment not synced)
3. Run `M-x eglot-python-preset-sync-environment`
4. Verify Eglot restarts and connects properly
5. Test completion to verify LSP sees dependencies

---

## Implementation Notes

### Detection Logic

Scan buffer for:

1. Line matching `^# /// script$`
2. Followed eventually by `^# ///$`

### Warning Behavior

When `uv python find --script` returns:

- Empty/error: Message that uv couldn't find Python
- System Python (not in `~/.cache/uv/environments`): Warning that deps not
  synced (once per script per session)
- Environment Python: No warning, return path

Always return whatever Python path is available so LSP can provide basic
functionality.

### Project Detection

The `eglot-python-preset--project-find` function:

1. For PEP-723 scripts: Returns `(python-script . SCRIPT-PATH)` so each script
   gets its own eglot server
2. For regular Python projects: Returns `(python-project . ROOT)` based on
   marker files like `pyproject.toml`

This is added to `project-find-functions` so it takes precedence.

### Advice vs Hook Approach

The workspace configuration uses `defadvice :around` on
`eglot--workspace-configuration-plist` rather than replacing
`eglot-workspace-configuration` because:

1. Less invasive - doesn't modify user's configuration
2. More composable - works with other packages
3. Handles both `workspace/didChangeConfiguration` and `workspace/configuration`
   requests from the LSP server
